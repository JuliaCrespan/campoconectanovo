
                document.getElementById('postContent').value = '';
            }

        } catch (error) {
            console.error('Erro ao criar postagem:', error);
            alert('Erro ao criar postagem: ' + error.message);
        }
    });

    // Função para mostrar o feed
    async function showFeed(userType) {
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('feedContainer').classList.remove('hidden');

        const feedTitle = document.getElementById('feedTitle');
        const oppositeType = userType === "produtor" ? "comprador" : "produtor";
        feedTitle.textContent = `Recomendações de ${oppositeType}s:`;

        loadPostsRealtime();
    }

    // Função de login
    document.getElementById('loginButton').addEventListener('click', async () => {
        const email = document.getElementById('emailLogin').value;
        const password = document.getElementById('passwordLogin').value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const userType = userDoc.data().userType;
                showFeed(userType);
            } else {
                throw new Error("Usuário não encontrado no Firestore.");
            }
        } catch (error) {
            alert('Erro ao fazer login: ' + error.message);
        }
    });


// Função de logout
async function logout() {
    try {
        await signOut(auth); // Faz o logout
        alert('Você saiu!');

        // Oculta o feed e mostra o container de autenticação
        document.getElementById('feedContainer').classList.add('hidden');
        document.getElementById('authContainer').classList.remove('hidden');
    } catch (error) {
        console.error("Erro ao fazer logout:", error);
        alert("Ocorreu um erro ao tentar sair. Tente novamente.");
    }
}

// Configura o evento de clique no botão "Sair"
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('logoutButton').addEventListener('click', logout);
});

    // Função de perfil
    document.getElementById('profileButton').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) {
            alert('Usuário não autenticado.');
            return;
        }

        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
               
                // Atualiza informações do perfil
                document.getElementById('profileEmail').innerText = userData.email || 'Não informado';
                document.getElementById('profileUserType').innerText = userData.userType || 'Não especificado';
                document.getElementById('profilePhone').innerText = userData.phone || 'Não informado';
                document.getElementById('profileCidade').innerText = userData.cidade || 'Não informado';
                document.getElementById('profileEstado').innerText = userData.estado || 'Não informado';
                document.getElementById('profilePropriedade').innerText = userData.nomePropriedade || 'Não informado';

                // Atualiza notificações
                const notificationsList = document.getElementById('notificationsList');
                notificationsList.innerHTML = ''; // Limpa as notificações anteriores
                const notifications = userData.notifications || [];
                if (notifications.length > 0) {
                    notifications.forEach((notif, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>Notificação ${index + 1}:</strong> Interesse no post ${notif.postId} por ${notif.from}`;
                        notificationsList.appendChild(li);
                    });
                } else {
                    notificationsList.innerHTML = '<li>Sem notificações.</li>';
                }

                // Redireciona para a página de perfil
                document.getElementById('feedContainer').classList.add('hidden');
                document.getElementById('profileContainer').classList.remove('hidden');
            } else {
                alert('Perfil não encontrado.');
            }
        } catch (error) {
            console.error('Erro ao buscar o perfil:', error);
            alert('Ocorreu um erro ao carregar o perfil.');
        }
    });
    // Alternar entre login e registro
    window.toggleForms = function toggleForms() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleLink = document.getElementById('toggleAuth');

        if (loginForm.classList.contains('hidden')) {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            toggleLink.innerHTML = "Ainda não tem uma conta? <a href='#'>Registre-se aqui</a>";
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            toggleLink.innerHTML = "Já tem uma conta? <a href='#'>Faça login aqui</a>";
        }
    };
// Função para retornar ao feed
function returnToFeed() {
    document.getElementById('profileContainer').classList.add('hidden'); // Oculta o perfil
    document.getElementById('feedContainer').classList.remove('hidden'); // Mostra o feed
}

// Configura o evento de clique no botão "Voltar ao Feed"
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('returnToFeedButton').addEventListener('click', returnToFeed);
});
 // Função para registro
 document.getElementById('registerButton').addEventListener('click', async () => {
        const email = document.getElementById('emailRegister').value;
        const password = document.getElementById('passwordRegister').value;
        const userType = document.getElementById('userType').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const name = document.getElementById('name').value;  // Captura o nome do usuário
        const cidade = document.getElementById('cidade').value;
        const estado = document.getElementById('estado').value;
        const nomePropriedade = document.getElementById('nomePropriedade').value;

        if (!email || !password) {
            alert('Por favor, preencha todos os campos.');
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            await setDoc(doc(db, "users", user.uid), {
                email: email,
                userType: userType,
                phone: phoneNumber,
                name: name,
                cidade: cidade, // Certifique-se de que está sendo salvo
                estado: estado,
                nomePropriedade: nomePropriedade, // Certifique-se de que está sendo salvo
                notifications: []
            });

            alert('Conta criada com sucesso!');
            showFeed(userType);
        } catch (error) {
            alert('Erro ao registrar usuário: ' + error.message);
        }
        document.addEventListener("DOMContentLoaded", function() {
        const postList = document.getElementById("postList");
        const savedPosts = JSON.parse(localStorage.getItem("posts")) || [];
        savedPosts.forEach(post => renderPost(post));

        const notificationList = document.getElementById("notificationList");
        const savedNotifications = JSON.parse(localStorage.getItem("notifications")) || [];
        savedNotifications.forEach(notif => renderNotification(notif));
    });

    function renderPost(content) {
        const postList = document.getElementById("postList");
        const li = document.createElement("li");
        li.classList.add("post");
        li.innerHTML = `${content} <
        
        div class="like-comment">
            <button onclick="likePost(this)"><i class="fas fa-thumbs-up"></i></button>
            <button onclick="commentPost(this)"><i class="fas fa-comment"></i></button>
        </div>`;
        postList.appendChild(li);
    }

    function renderNotification(content) {
        const notificationList = document.getElementById("notificationList");
        const li = document.createElement("li");
        li.textContent = content;
        notificationList.appendChild(li);
    }



    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
    }
    });
    // Função para fretistas demonstrarem interesse em fretes
async function declareFreightInterest(postId, postOwnerId) {
    const user = auth.currentUser;
    if (!user) {
        alert("Você precisa estar logado para demonstrar interesse.");
        return;
    }

    // Verificar se o usuário é fretista
    const userRef = doc(db, "users", user.uid);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists() || userDoc.data().role !== "fretista") {
        alert("Apenas fretistas podem demonstrar interesse em fretes.");
        return;
    }

    try {
        // Buscar dados do post
        const postRef = doc(db, "posts", postId);
        const postDoc = await getDoc(postRef);
        if (!postDoc.exists()) {
            alert("O post não existe.");
            return;
        }

        // Buscar dados do dono do post
        const ownerRef = doc(db, "users", postOwnerId);
        const ownerDoc = await getDoc(ownerRef);
        if (!ownerDoc.exists()) {
            alert("Dono do post não encontrado.");
            return;
        }

        const userName = userDoc.data().name;
        const userPhone = userDoc.data().phone || "Telefone não informado";
        const ownerPhone = ownerDoc.data().phone;

        // Atualizar a lista de interessados no post
        await updateDoc(postRef, {
            interestedFreight: arrayUnion({
                name: userName,
                phone: userPhone,
                id: user.uid
            })
        });

        // Atualizar notificações do dono do post
        await updateDoc(ownerRef, {
            notifications: arrayUnion({
                type: "freight_interest",
                from: {
                    name: userName,
                    phone: userPhone,
                    id: user.uid
                },
                postId: postId,
                timestamp: new Date().toISOString()
            })
        });

        alert("Interesse registrado com sucesso! O dono do post foi notificado.");

    } catch (error) {
        console.error("Erro ao declarar interesse em frete:", error);
        alert("Ocorreu um erro ao tentar declarar interesse. Tente novamente.");
    }
}
// Função para limpar notificações
async function clearNotifications() {
    console.log("Função clearNotifications chamada!"); // Depuração
    const user = auth.currentUser;
    if (!user) {
        alert("Você precisa estar logado para limpar as notificações.");
        return;
    }

    try {
        // Referência ao documento do usuário no Firestore
        const userRef = doc(db, "users", user.uid);
        console.log("Referência do usuário:", userRef); // Depuração

        // Atualiza o documento do usuário, definindo o campo "notifications" como um array vazio
        await updateDoc(userRef, {
            notifications: []
        });
        console.log("Notificações limpas no Firestore."); // Depuração

        // Atualiza a interface do usuário
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = '<li>Sem notificações no momento.</li>';

        alert("Notificações limpas com sucesso!");
    } catch (error) {
        console.error("Erro ao limpar notificações:", error); // Depuração
        alert("Ocorreu um erro ao tentar limpar as notificações. Tente novamente.");
    }
}

// Configura o evento de clique no botão "Limpar Notificações"
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('clearNotificationsButton').addEventListener('click', clearNotifications);
});

// Variável global para armazenar o ID do chat ativo
let activeChatId = null;

// Função para iniciar o chat
async function startChat(postId, postOwnerId) {
    const user = auth.currentUser;
    if (!user) {
        alert("Você precisa estar logado para iniciar um chat.");
        return;
    }

    const userId = user.uid;

    try {
        // Verifica se já existe um chat entre esses usuários para o mesmo post
        const chatsRef = collection(db, "chats");
        const q = query(
            chatsRef,
            where("users", "array-contains", userId), // Verifica se o usuário atual está no chat
            where("postId", "==", postId) // Verifica se o chat é para o mesmo post
        );
        const querySnapshot = await getDocs(q);

        let chatId = null;

        // Se já existir um chat, usa o ID desse chat
        if (!querySnapshot.empty) {
            querySnapshot.forEach((doc) => {
                const chatData = doc.data();
                if (chatData.users.includes(postOwnerId)) { // Verifica se o dono do post está no chat
                    chatId = doc.id;
                }
            });
        }

        // Se não existir um chat, cria um novo
        if (!chatId) {
            const chatRef = await addDoc(collection(db, "chats"), {
                users: [userId, postOwnerId], // IDs dos participantes
                messages: [], // Array de mensagens vazio
                createdAt: new Date().toISOString(), // Data de criação
                postId: postId // ID do post relacionado
            });
            chatId = chatRef.id;
            console.log("Novo chat criado com ID:", chatId);
        } else {
            console.log("Chat existente encontrado com ID:", chatId);
        }

        // Atualiza o ID do chat ativo
        activeChatId = chatId;

        // Redireciona para a tela de chat
        openChat(activeChatId);

        // Adiciona uma notificação para o dono do post (se o usuário atual não for o dono do post)
        if (userId !== postOwnerId) {
            await addNotification(chatId, userId, postOwnerId, postId);
        }
    } catch (error) {
        console.error("Erro ao iniciar o chat:", error);
        alert("Ocorreu um erro ao tentar iniciar o chat. Tente novamente.");
    }
}

// Função para abrir o chat
function openChat(chatId) {
    console.log("Abrindo chat com ID:", chatId);

    // Oculta o feed e exibe a interface de chat
    document.getElementById('feedContainer').classList.add('hidden');
    document.getElementById('chatContainer').classList.remove('hidden');

    // Atualiza o ID do chat ativo
    activeChatId = chatId;

    // Carrega as mensagens do chat
    loadChatMessages(chatId);
}

// Função para carregar mensagens do chat
function loadChatMessages(chatId) {
    const messagesRef = collection(db, "chats", chatId, "messages");
    const messagesContainer = document.getElementById('messages');

    // Limpa as mensagens anteriores
    messagesContainer.innerHTML = '';

    // Escuta por novas mensagens em tempo real
    onSnapshot(messagesRef, (snapshot) => {
        snapshot.forEach((doc) => {
            const message = doc.data();
            const messageElement = document.createElement('div');
            messageElement.textContent = `${message.sender}: ${message.text}`;
            messagesContainer.appendChild(messageElement);
        });
    });
}

// Função para enviar mensagens
async function sendMessage(chatId) {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();

    if (messageText) {
        const user = auth.currentUser;
        if (!user) {
            alert("Você precisa estar logado para enviar mensagens.");
            return;
        }

        try {
            // Adiciona a mensagem ao Firestore
            await addDoc(collection(db, "chats", chatId, "messages"), {
                sender: user.uid,
                text: messageText,
                createdAt: new Date().toISOString()
            });

            console.log("Mensagem enviada com sucesso!");
            messageInput.value = '';

            // Adiciona uma notificação para o outro usuário
            const chatRef = doc(db, "chats", chatId);
            const chatDoc = await getDoc(chatRef);

            if (chatDoc.exists()) {
                const chatData = chatDoc.data();
                const users = chatData.users; // IDs dos participantes do chat

                // Encontra o ID do outro usuário (não o remetente)
                const otherUserId = users.find((userId) => userId !== user.uid);

                if (otherUserId) {
                    await addNotificationint(chatId, user.uid, otherUserId, chatData.postId);
                }
            }

            // Atualiza as notificações na interface
            loadNotificationsint();
        } catch (error) {
            console.error("Erro ao enviar mensagem:", error);
            alert("Ocorreu um erro ao tentar enviar a mensagem. Tente novamente.");
        }
    }
}

// Função para adicionar notificação
async function addNotificationint(chatId, senderId, receiverId, postId) {
    try {
        // Busca os dados do usuário remetente (quem enviou a mensagem)
        const senderRef = doc(db, "users", senderId);
        const senderDoc = await getDoc(senderRef);

        if (senderDoc.exists()) {
            const senderData = senderDoc.data();
            const userName = senderData.name || "Usuário";
            const userPhone = senderData.phone || "N/A";

            // Adiciona a notificação ao documento do destinatário
            const receiverRef = doc(db, "users", receiverId);
            await updateDoc(receiverRef, {
                notifications: arrayUnion({
                    type: "new_message",
                    message: `Você recebeu uma nova mensagem de ${userName} (${userPhone}).`,
                    chatId: chatId,
                    postId: postId,
                    timestamp: new Date().toISOString()
                })
            });

            console.log("Notificação adicionada para o usuário:", receiverId);
        } else {
            console.error("Dados do remetente não encontrados.");
        }
    } catch (error) {
        console.error("Erro ao adicionar notificação:", error);
    }
}

function loadNotificationsint() {
    const user = auth.currentUser;
    if (!user) {
        console.log("❌ Usuário não autenticado.");
        return;
    }

    const userRef = doc(db, "users", user.uid);

    onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            const userData = docSnap.data();
            console.log("🔍 Dados do usuário (tempo real):", userData);

            const notifications = userData.notifications || [];
            console.log("📩 Notificações carregadas (tempo real):", notifications);

            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';

            if (notifications.length === 0) {
                notificationsList.innerHTML = "<li>📭 Nenhuma notificação</li>";
                return;
            }

            notifications.forEach((notif) => {
                const li = document.createElement('li');
                li.textContent = notif.message;
                notificationsList.appendChild(li);
            });
        } else {
            console.log("⚠️ Documento do usuário não encontrado!");
        }
    }, (error) => {
        console.error("🔥 Erro ao carregar notificações em tempo real:", error);
    });
}



// Função para sair do chat
function exitChat() {
    console.log("Saindo do chat...");

    // Oculta o chat e exibe o feed
    document.getElementById('feedContainer').classList.remove('hidden');
    document.getElementById('chatContainer').classList.add('hidden');

    // Limpa o ID do chat ativo
    activeChatId = null;

    // Limpa as mensagens exibidas
    document.getElementById('messages').innerHTML = '';
}

// Configura o evento de clique no botão "Enviar"
document.addEventListener('DOMContentLoaded', function () {
    const sendMessageButton = document.getElementById('sendMessageButton');
    if (sendMessageButton) {
        sendMessageButton.addEventListener('click', function () {
            if (activeChatId) {
                sendMessage(activeChatId);
            } else {
                alert("Nenhum chat ativo.");
            }
        });
    }
});

// Configura o evento de clique no botão "Sair do Chat"
document.addEventListener('DOMContentLoaded', function () {
    const exitChatButton = document.getElementById('exitChatButton');
    if (exitChatButton) {
        exitChatButton.addEventListener('click', exitChat);
    } else {
        console.error("Botão de sair do chat não encontrado!");
    }
});
document.addEventListener('DOMContentLoaded', function () {
    // Seleciona todos os botões com a classe "fecharVendaButton"
    const fecharVendaButtons = document.querySelectorAll('.fecharVendaButton');

    // Adiciona o evento de clique a cada botão
    fecharVendaButtons.forEach(button => {
        button.addEventListener('click', async function () {
            const chatId = this.getAttribute('data-chat-id');  // Usar data-chat-id ao invés de post-id
            const respostaFrete = confirm("Precisa de frete?");
            
            let listaFretistas = "";
            if (respostaFrete) {
                const fretistas = await buscarFretistasDisponiveis();
                if (fretistas.length > 0) {
                    listaFretistas = fretistas.join("\n");
                    alert(`🚚 *Fretistas disponíveis:*\n\n${listaFretistas}`);
                } else {
                    alert("Nenhum fretista disponível no momento.");
                }
            }

            // Notifica o ADM sobre a resposta
            if (respostaFrete) {
                alert("Administrador notificado sobre a necessidade de frete.");
            } else {
                alert("Administrador notificado sobre a venda, sem necessidade de frete.");
            }
 
            // Enviar a notificação ao ADM com os nomes dos envolvidos e dos fretistas disponíveis
            await enviarFretistasParaADM(respostaFrete, listaFretistas);
            // Marcar o post como vendido
       // Marcar o chat como vendido (não usa mais postId)
       await marcarChatComoVendido(chatId);  // Aqui usamos o data-chat-id
        });
    });

    // Função para marcar o chat como vendido
    async function marcarChatComoVendido(chatId) {
        try {
            const chatRef = doc(db, "chats", chatId);
            await updateDoc(chatRef, { status: "vendido" });  // Marca o chat como "vendido"
            alert("Venda concluída! O chat foi marcado como vendido.");
            window.location.reload(); // Atualiza a página para refletir as mudanças
        } catch (error) {
            console.error("Erro ao marcar o chat como vendido:", error);
        }
    }


    async function buscarFretistasDisponiveis() {
        try {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("userType", "==", "fretista"));
            const querySnapshot = await getDocs(q);

            let fretistas = [];
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.name && userData.phone) {
                    fretistas.push(`- ${userData.name} (📞 ${userData.phone})`);
                }
            });

            return fretistas;
        } catch (error) {
            console.error("Erro ao buscar fretistas:", error);
            return [];
        }
    }

    async function enviarFretistasParaADM(precisaFrete, listaFretistas) {
        try {
            if (!activeChatId) {
                console.error("Nenhum chat ativo encontrado.");
                return;
            }

            // Pega os dados do chat usando o activeChatId
            const chatDoc = await getDoc(doc(db, "chats", activeChatId));

            if (!chatDoc.exists()) {
                console.error("Chat não encontrado para o chatId:", activeChatId);
                return;
            }

            const chatData = chatDoc.data();
            const usersIds = chatData.users; // IDs dos participantes do chat

            // Busca os nomes dos usuários
            const usersNames = await Promise.all(
                usersIds.map(async (userId) => {
                    const userRef = doc(db, "users", userId);
                    const userDoc = await getDoc(userRef);
                    return userDoc.exists() ? userDoc.data().name : "Usuário Desconhecido";
                })
            );

            // Cria a mensagem com os nomes dos envolvidos e dos fretistas disponíveis
            let mensagem = `🚨 *Venda Fechada!*\n\n👥 *Participantes:* ${usersNames.join(", ")}\n📦 *Necessita de Frete?* ${precisaFrete ? 'Sim' : 'Não'}`;

            if (precisaFrete && listaFretistas) {
                mensagem += `\n🚚 *Fretistas disponíveis:*\n${listaFretistas}`;
            }

            mensagem = encodeURIComponent(mensagem);

            // Envia a mensagem pelo WhatsApp usando CallMeBot
            await sendWhatsAppNotification(mensagem);
        } catch (error) {
            console.error("Erro ao enviar notificação: ", error);
        }
    }

    // Função para enviar a notificação via WhatsApp
    async function sendWhatsAppNotification(message) {
        const url = `https://api.callmebot.com/whatsapp.php?phone=${+554396811736}&text=${message}&apikey=${1253447}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Erro ao enviar a mensagem pelo WhatsApp.");
            }
            console.log("Mensagem enviada com sucesso!");
        } catch (error) {
            console.error("Erro ao enviar mensagem: ", error);
        }
    }
});


// Função para tratar o clique do botão de fechar venda
const fecharVendaButtons = document.querySelectorAll('.fecharVendaButton');
fecharVendaButtons.forEach(button => {
    button.addEventListener('click', async function () {
        const postId = this.getAttribute('data-post-id');
        const respostaFrete = confirm("Precisa de frete?");
    }
)
}
) 
async function marcarComoVendido(chatId) {
    try {
        // Acessa o documento do chat pelo ID
        const chatRef = doc(db, "chats", chatId);

        // Atualiza o status para "vendido"
        await updateDoc(chatRef, {
            status: "vendido"  // Marca o chat como "vendido"
        });

        console.log("Post marcado como vendido!");
    } catch (error) {
        console.error("Erro ao marcar o post como vendido: ", error);
    }
}
document.addEventListener('DOMContentLoaded', function () {
    const fecharVendaButtons = document.querySelectorAll('.fecharVendaButton');

    fecharVendaButtons.forEach(button => {
        button.addEventListener('click', async function () {
            const chatId = this.getAttribute('data-chat-id');  // Usar data-chat-id ao invés de post-id
            const respostaFrete = confirm("Precisa de frete?");

            // Notifica o ADM sobre a resposta
            if (respostaFrete) {
                alert("Administrador notificado sobre a necessidade de frete.");
            } else {
                alert("Administrador notificado sobre a venda, sem necessidade de frete.");
            }

            // Enviar a notificação ao ADM com os nomes dos envolvidos
            await enviarFretistasParaADM(chatId, respostaFrete);

        
        });
    });
});

</script>
</html>
